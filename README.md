# docker-local-api

This guide walks you through setting up a modern local API development environment using **Docker**, **Node.js**, **TypeScript**, and **Express**, complete with hot-reloading for an efficient workflow.

---

## Setup and Initialization

1.  **Create Project Folder**
    > If you are able to, create a Git repo, clone, and use that folder as your project root.

2.  **Create `Dockerfile`**
    Add the following content to define your base environment:

    ```Dockerfile
    FROM node:22-alpine

    WORKDIR /app
    ```

3.  **Create `docker-compose.yaml`**
    Add the following content to define your service and local volume:

    ```yaml
    ---
    services:
      app:
        build: .
        volumes:
          - ./app:/app
    ```

4.  **Install Dependencies**
    Execute the following commands to initialize your Node project and install core packages:

    -   **(Optional)** Run `docker compose build`
    -   **(Optional)** Run `docker compose run --rm app node --version`
    -   Run `docker compose run --rm app npm init -y`
        > Notice how the `app` directory is automatically created on your host machine due to the volume mount.
    -   **(Optional)** Run `docker compose run --rm app npm install`
        > Notice this automatically creates a `package-lock.json` file.
    -   Run `docker compose run --rm app npm add --save-dev @types/node@22 @tsconfig/recommended typescript`

---

## TypeScript Configuration

1.  **Create `tsconfig.json`**
    Add the following content to configure the TypeScript compiler:

    ```json
    {
      "extends": "@tsconfig/recommended/tsconfig.json",
      "compilerOptions": {
        "outDir": "./dist"
      }
    }
    ```

    > [!NOTE]
    > This configuration could be auto-generated by running `docker compose run --rm app npx tsc --init`, but our current setup results in cleaner, more concise settings by using the recommended configuration preset.

2.  **Create `./src/index.ts`**
    Create the source file with a simple test:

    ```typescript
    console.log('Hello world!');
    ```

3.  **Add Build and Start Scripts**
    Add the following to the `scripts` section in your `package.json`:

    ```json
    "start": "node ./dist/index.js",
    "build": "tsc",
    ```

4.  **Test the Build Process**
    -   Run `docker compose run --rm app npm run build`
        > You'll notice an `index.js` file has now appeared inside a newly created `./dist` folder.
    -   Run `docker compose run --rm app npm start`
        > You should see a couple of lines of Node debug followed by your `Hello world!`.

---

## Adding Express and Port Mapping

1.  **Install Express**
    Install the core Express package and its TypeScript definitions:
    -   Run `docker compose run --rm app npm add express`
        > Notice how this one is not marked as `--save-dev`. You'll see a new `dependencies` section has been added to `package.json`.
    -   Run `docker compose run --rm app npm add --save-dev @types/express`

2.  **Update `./src/index.ts`**
    Replace the contents with the Express server code:

    ```typescript
    import express from 'express';

    const app = express();
    const port = 3000;

    app.get('/', (_req, res) => res.json({ message: 'Hello World!' } ));

    app.listen(port, () => console.log(`Example app listening on port ${port}`));
    ```

3.  **Test the Server (Initial)**
    -   Run `docker compose run --rm app npm run build`
    -   Run `docker compose run --rm app npm start`

    > [!IMPORTANT]
    > This time you'll notice the container doesn't exit, as the Express server is running. If you try accessing `http://localhost:3000` it won't work yet because the port isn't published. **Exit the container by pressing `Ctrl+C`** on your keyboard.

4.  **Set Default Command and Publish Port**
    -   Update the end of your `Dockerfile`:

        ```Dockerfile
        CMD [ "npm", "start" ]
        ```
        > We have now defined what the default command for our container is.

    -   Run `docker compose build`

    -   Update `docker-compose.yaml` to include the port mapping:

        ```yaml
        ports:
          - 3000:3000
        ```

    -   Run `docker compose up`
        > **Note:** This is different from the previous `docker compose run`. If you open `http://localhost:3000` in your browser now, it should work.

---

## Enabling Hot Reloading

1.  **Install Development Tools**
    -   Update the `./src/index.ts` from `Hello World!` to `Hello Universe!`
        > If you refresh your browser, nothing has changed yet. We'll fix that next.
    -   Run `docker compose run --rm app npm add --save-dev nodemon ts-node`

2.  **Add `dev` Script**
    Add a new script in `package.json` to start `nodemon`:

    ```json
    "start": "node ./dist/index.js",
    "build": "tsc",
    "dev": "nodemon ./src/index.ts"
    ```

3.  **Switch to Development Command**
    Update `docker-compose.yaml` to override the default `CMD`:

    ```yaml
    command:
      - npm
      - run
      - dev
    ```

4.  **Final Test**
    -   Run `docker compose up`
        > You'll now see the `Hello Universe!` message in your browser.
    -   Update the `./src/index.ts` back to `Hello World!`
        > You should immediately notice in your container logs that **`nodemon` has restarted** due to changes, and a refresh of your browser has the new content without you needing to stop, build, or start the container.
